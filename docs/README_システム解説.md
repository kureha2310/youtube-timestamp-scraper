# YouTube歌配信タイムスタンプ管理システム 解説

## 📋 目次
1. [システム全体像](#システム全体像)
2. [Phase 1: データ収集（Pythonスクレイパー）](#phase-1-データ収集pythonスクレイパー)
3. [Phase 2: データ可視化（Google Apps Script）](#phase-2-データ可視化google-apps-script)
4. [データフロー図](#データフロー図)

---

## システム全体像

このシステムは、YouTubeの歌配信動画からタイムスタンプ情報を自動収集し、Googleスプレッドシートで管理・可視化する2段階のパイプラインです。

```
┌─────────────────────┐
│  YouTubeチャンネル   │
│   (歌配信動画)      │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  Pythonスクレイパー  │  ← Phase 1: データ収集
│  ・動画検出         │
│  ・タイムスタンプ抽出│
│  ・重複除去         │
└──────┬──────────────┘
       │
       │ song_timestamps_complete.csv
       │
       ▼
┌─────────────────────┐
│ Googleスプレッドシート│
│   (手動インポート)   │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ Google Apps Script  │  ← Phase 2: データ可視化
│  ・ジャンル別分類   │
│  ・歌唱履歴集約     │
│  ・リンク生成       │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  出力シート          │
│ ・🦉リスト(Vocaloid) │
│ ・🦉リスト(アニメ)   │
│ ・🦉リスト(その他)   │
└─────────────────────┘
```

---

## Phase 1: データ収集（Pythonスクレイパー）

### 🎯 目的
YouTubeチャンネルの動画から、歌配信のタイムスタンプ情報を自動的に収集する

### 📂 主要ファイル
- `src/extractors/youtube_song_scraper.py` - メインスクレイパー

### 🔧 処理フロー

#### ステップ1: 動画情報の取得
```python
def get_video_info_in_playlist(playlist_id: str) -> list[VideoInfo]:
```
- YouTube Data API v3を使用
- チャンネルの全動画を取得
- タイトル、説明文、公開日などのメタデータを収集

#### ステップ2: 歌配信の検出
```python
def is_singing_stream(title: str, description: str, comments: Optional[List[str]] = None) -> bool:
```

**判定基準:**
1. **タイトル・説明文のキーワード分析**
   - 「歌」「歌枠」「カラオケ」「singing」などを検出
   - 除外キーワード: 「ゲーム」「雑談」「料理」など

2. **コメント分析（強化機能）**
   - コメント内のタイムスタンプ数をカウント
   - 3つ以上のタイムスタンプを含むコメントが複数ある場合、歌配信と判定

3. **スコアリング**
   ```python
   確度スコア = (歌関連キーワード数 - 除外キーワード数) / 10.0
   ```
   - 0.0〜1.0の範囲で信頼度を算出

#### ステップ3: タイムスタンプ抽出
```python
class TimeStamp:
    def from_text(cls, video_id, video_title, published_at, text):
```

**抽出パターン:**
- HTMLアンカー形式: `<a href="...&t=413">6:53</a> サイハテ/小林オニキス`
- プレーンテキスト: `6:53 サイハテ/小林オニキス feat. 初音ミク`

**ナンバリング除去:**
```python
def clean_title(self, text: str) -> str:
```
- `01.` `1)` `【1】` `(1)` などを自動除去
- 全角数字を半角に統一
- 装飾記号（`＆` `★` `※`など）も除去

#### ステップ4: 重複統合
```python
# 第1パス: グループ化
normalized_key = (
    song_title.lower().strip(),
    artist.lower().strip(),
    video_id,
    total_seconds // 5  # 5秒単位で丸める
)
```

**統合ルール:**
- 同じ曲・同じ動画・近い時間（±5秒）のタイムスタンプを1つに統合
- ナンバリングのないもの、詳細な情報を持つものを優先

#### ステップ5: CSV出力
```python
# 配信日とタイムスタンプでソート（古い順）
rows.sort(key=lambda x: (x[6], x[9]))
```

**出力形式:**
```csv
No,曲,歌手-ユニット,検索用,ジャンル,タイムスタンプ,配信日,動画ID,確度スコア
1,マリーゴールド,あいみょん,まりーごーるど,その他,00:04:48,2025/02/04,N9dsnKVpRwA,0.60
```

### 📊 出力統計の例
```
処理した動画数: 74件
抽出したタイムスタンプ数: 369件
最終出力行数: 210件（重複除去後）
```

---

## Phase 2: データ可視化（Google Apps Script）

### 🎯 目的
CSVデータをジャンル別に分類し、同じ曲の歌唱履歴を集約して見やすく表示

### 📂 スプレッドシート構成
```
├── リスト(一覧)           ← CSVインポート先
├── 🦉出力(テンプレート)    ← 書式テンプレート
├── 🦉リスト(Vocaloid)     ← 自動生成（実行時）
├── 🦉リスト(アニメ)       ← 自動生成（実行時）
└── 🦉リスト(その他)       ← 自動生成（実行時）
```

### 🔧 関数解説

#### メイン関数: `outputAllGenresToSheets()`
```javascript
function outputAllGenresToSheets() {
  const genres = ['Vocaloid', 'アニメ', 'その他'];
  for (const genre of genres) {
    outputSongsByGenreWithTemplate(genre);
  }
}
```
**役割:** 3つのジャンル全てに対してシート生成を実行

---

#### コア関数: `outputSongsByGenreWithTemplate(targetGenre)`

##### 🔹 ステップ1: データ読み込み
```javascript
const sourceSheet = ss.getSheetByName('リスト(一覧)');
const allData = sourceSheet.getRange('A2:H').getDisplayValues().filter(r => r[1]);
```
- 「リスト(一覧)」シートから全データを取得
- 空行を除外

##### 🔹 ステップ2: ジャンルフィルタリング
```javascript
const filtered = allData.filter(row => row[4] && row[4].includes(targetGenre));
```
- 列E（ジャンル列）が指定ジャンルを含む行のみ抽出

##### 🔹 ステップ3: 曲ごとにグループ化
```javascript
const grouped = {};
for (const row of filtered) {
  const normalize = str => str.replace(/\s/g, '').replace(/　/g, '').toLowerCase();
  const key = `${normalize(title)}|${normalize(artist)}`;

  if (!grouped[key]) grouped[key] = { title, artist, logs: [] };
  // ...
}
```

**正規化処理:**
- 全角・半角スペースを除去
- 小文字に統一
- これにより「マリーゴールド / あいみょん」と「マリーゴールド/あいみょん」が同一曲として認識される

##### 🔹 ステップ4: タイムスタンプをYouTubeリンクに変換
```javascript
const seconds = hmsToSeconds(timestamp);  // "1:23:45" → 5025秒
const url = `https://www.youtube.com/watch?v=${videoId}&t=${seconds}s`;
const linkFormula = `=HYPERLINK("${url}", "${tsStr}")`;
```

**変換例:**
```
入力: タイムスタンプ "1:23:45", 動画ID "abc123xyz"
出力: =HYPERLINK("https://www.youtube.com/watch?v=abc123xyz&t=5025s", "01:23:45")
      ↓
スプレッドシート上でクリック可能なリンクとして表示
```

##### 🔹 ステップ5: 出力テーブル作成
```javascript
const output = [];
for (const key in grouped) {
  const { title, artist, logs } = grouped[key];
  const count = logs.length;  // 歌唱回数
  output.push([count, title, artist, ...flatLogs]);
}
```

**出力形式イメージ:**
```
| 回数 | 曲名           | アーティスト | 配信日1    | TS1      | 配信日2    | TS2      |
|------|----------------|--------------|------------|----------|------------|----------|
| 3    | マリーゴールド | あいみょん   | 2025/02/04 | 00:04:48 | 2025/03/15 | 01:23:45 |
| 2    | シャルル       | バルーン     | 2025/02/10 | 02:15:30 | 2025/04/01 | 03:45:12 |
```

##### 🔹 ステップ6: シート生成
```javascript
const template = ss.getSheetByName('🦉出力(テンプレート)');
const newSheet = template.copyTo(ss);
newSheet.setName(`🦉リスト(${targetGenre})`);
```
- テンプレートをコピーして書式を継承
- 既存シートがあれば削除して再作成

---

#### ユーティリティ関数

##### `hmsToSeconds(hms)` - タイムスタンプを秒に変換
```javascript
// "1:23:45" → 5025秒
// "23:45"   → 1425秒
// "45"      → 45秒
```

##### `secondsToHMS(seconds)` - 秒をタイムスタンプに変換
```javascript
// 5025秒 → "01:23:45"
// 1425秒 → "00:23:45"
```

---

## データフロー図

### 詳細フロー

```
┌────────────────────────────────────────────────────────────┐
│                    YouTube Data API                        │
└───────────────────┬────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │  動画メタデータ取得                    │
    │  - タイトル: "【#歌枠】～"            │
    │  - 説明文: "セトリ: 6:53 曲名/歌手"   │
    │  - 公開日: 2025-02-04T12:00:00Z      │
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  歌配信判定（スコアリング）             │
    │  ✓ タイトルに「歌枠」含む (+3点)       │
    │  ✓ 説明文に「セトリ」含む (+1点)       │
    │  ✓ コメントに大量のTS (+4点)          │
    │  → 確度スコア: 0.80                   │
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  コメント取得 & TS抽出                 │
    │  例: "6:53 サイハテ/小林オニキス"     │
    │      "14:19 アイデンティティ/Kanaria"│
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  データクレンジング                    │
    │  - "01.サイハテ" → "サイハテ"        │
    │  - "＆ 負けないで" → "負けないで"     │
    │  - 曲名/アーティスト分離               │
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  重複統合                              │
    │  6:53, 6:55, 6:57 の3エントリ        │
    │  → 最も詳細な 6:53 のみ残す          │
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  CSV出力（古い順ソート）               │
    │  song_timestamps_complete.csv         │
    └───────────┬───────────────────────────┘
                │
                │ 手動インポート
                ▼
    ┌───────────────────────────────────────┐
    │  Googleスプレッドシート                │
    │  シート: リスト(一覧)                  │
    └───────────┬───────────────────────────┘
                │
                │ GAS実行
                ▼
    ┌───────────────────────────────────────┐
    │  outputAllGenresToSheets()            │
    │  ├─ Vocaloid                          │
    │  ├─ アニメ                            │
    │  └─ その他                            │
    └───────────┬───────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  各ジャンル別シート                    │
    │  ┌─────────────────────────────────┐ │
    │  │回数│曲名│配信日1│TS1│配信日2│TS2││ │
    │  ├─────────────────────────────────┤ │
    │  │ 3 │xxx │ ...   │🔗│  ...  │🔗││ │
    │  │ 2 │yyy │ ...   │🔗│       │  ││ │
    │  └─────────────────────────────────┘ │
    └───────────────────────────────────────┘
```

---

## 🎨 特徴的な機能

### 1. **インテリジェントな歌配信検出**
- タイトルに「歌枠」がなくても、コメント分析で検出
- 確度スコアで信頼性を可視化

### 2. **強力なクレンジング**
```python
# 入力例
"01. ＆ サイハテ / 小林オニキス feat. 初音ミク"

# 処理
1. "01." を除去
2. "＆" を除去
3. "サイハテ" と "小林オニキス feat. 初音ミク" に分離

# 出力
曲名: "サイハテ"
アーティスト: "小林オニキス feat. 初音ミク"
```

### 3. **重複統合アルゴリズム**
```python
同一曲の判定:
- 曲名とアーティスト名を正規化（空白除去、小文字化）
- タイムスタンプが±5秒以内
- 同じ動画ID

優先順位:
1. ナンバリングなし > ナンバリングあり
2. 曲名が長い（詳細） > 短い
3. アーティスト名が長い > 短い
```

### 4. **動的なシート構造**
```javascript
// 歌った回数に応じて列数が動的に変化
歌唱1回の曲: [回数][曲名][配信日1][TS1]
歌唱3回の曲: [回数][曲名][配信日1][TS1][配信日2][TS2][配信日3][TS3]
```

---

## 🚀 実行方法

### Phase 1: データ収集
```bash
cd youtube-timestamp-scraper
python src/extractors/youtube_song_scraper.py
```

### Phase 2: データ可視化
1. `song_timestamps_complete.csv` をGoogleスプレッドシートの「リスト(一覧)」にインポート
2. GASエディタで `outputAllGenresToSheets()` を実行
3. 自動的に3つのジャンル別シートが生成される

---

## 📈 実行結果の例

### スクレイパー統計
```
全動画数: 115
歌枠動画数: 74
抽出タイムスタンプ数: 369
重複除去後: 210

確度スコア分布:
- 高確度 (>0.7): 20件
- 中確度 (0.4-0.7): 144件
- 低確度 (<0.4): 46件
```

### GAS出力例
**🦉リスト(Vocaloid)シート:**
```
| 回数 | 曲名                 | アーティスト      | 配信日1    | TS1         | 配信日2    | TS2         |
|------|---------------------|------------------|-----------|-------------|-----------|-------------|
| 3    | メルト              | ryo(supercell)   | 2025/02/04| [01:14:49]  | 2025/03/17| [02:15:30]  |
| 2    | ローリンガール       | wowaka          | 2025/02/04| [01:06:56]  | 2025/05/10| [03:45:12]  |
```
※ TSはクリック可能なYouTubeリンク

---

## 🔧 カスタマイズ

### 新しいジャンルを追加
```javascript
// GAS側
const genres = ['Vocaloid', 'アニメ', 'その他', '新ジャンル'];

// Python側（src/extractors/youtube_song_scraper.py）
self.custom_keywords = ["キーワード1", "キーワード2"]
```

### タイムスタンプパターンの追加
```python
# src/utils/infoclass.py の TimeStamp クラス
pattern = r'新しいパターン'
```

---

## 🐛 トラブルシューティング

### よくある問題

**Q: 歌配信なのに検出されない**
- `is_singing_stream` の `minimum_score` を下げる
- 新しいキーワードを `singing_keywords` に追加

**Q: ゲーム配信が混入する**
- `exclude_keywords` にゲームタイトルを追加

**Q: ナンバリングが残る**
- `clean_title` の正規表現パターンを追加

**Q: GASでエラーが出る**
- シート名「リスト(一覧)」が存在するか確認
- テンプレートシート「🦉出力(テンプレート)」が存在するか確認

---

## 📝 ライセンス・注意事項

- YouTube Data API v3の利用規約に従ってください
- APIクォータ制限に注意（1日10,000ユニット）
- 個人利用目的を推奨
