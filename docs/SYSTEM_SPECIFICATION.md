# YouTubeタイムスタンプ抽出システム - 仕様書

## 📋 プロジェクトの目的

### 主目的
**YouTubeの歌配信動画からタイムスタンプを正確に取得してCSV形式で出力する**

### 副目的
- アーティスト名を正確に抽出する
- ジャンル（Vocaloid/J-POP/アニメ/その他）を自動分類する
- 確度スコアで歌配信の信頼性を評価する

---

## 🎯 システムの核心

### 最も重要なこと
1. **タイムスタンプの正確な抽出** - 「曲名 / アーティスト」形式が理想
2. **重複排除** - 同じ曲が複数回出てこないようにする
3. **ノイズ除去** - 歌ではないタイムスタンプ（雑談、ゲーム等）を除外

### 品質の判断基準
- アーティスト名の抽出率が高いほど良い（80%以上が理想）
- 確度スコアが高いほど歌配信として信頼できる
- ジャンル分類の精度

---

## 🏗️ システムアーキテクチャ

### データフロー
```
[user_ids.json] → [YouTube API] → [動画情報取得]
                                        ↓
                            [歌配信判定（1次フィルタ）]
                                        ↓
                            [コメント取得]
                                        ↓
                            [歌配信判定（2次フィルタ）]
                                        ↓
                            [タイムスタンプ抽出]
                                        ↓
                            [アーティスト名分離]
                                        ↓
                            [ジャンル分類]
                                        ↓
                            [確度スコア計算]
                                        ↓
                            [重複除去]
                                        ↓
                    [CSV出力] + [統計表示]
```

---

## 📂 主要なファイル構成

### コアファイル
```
youtube-timestamp-scraper/
├── main.py                          # メインメニュー
├── user_ids.json                    # チャンネルID設定
├── config.json                      # 基本設定
├── .env                             # YouTube API Key
│
├── src/
│   ├── extractors/
│   │   └── youtube_song_scraper.py  # ★メインロジック（最重要）
│   │
│   └── utils/
│       ├── genre_classifier.py      # ジャンル分類
│       ├── channel_manager.py       # チャンネル管理
│       └── infoclass.py             # データクラス
│
├── config/
│   └── genre_keywords.json          # ジャンル分類用キーワード辞書
│
└── output/
    ├── csv/
    │   └── song_timestamps_complete.csv  # ★最終出力（最重要）
    └── json/
        └── comment_info.json        # バックアップ
```

---

## 🔧 主要コンポーネントの役割

### 1. youtube_song_scraper.py（メインロジック）

#### 主要クラス: `EnhancedAnalyzer`

**責任範囲:**
- タイムスタンプの解析
- ジャンル分類
- 確度スコア計算
- アーティスト名の抽出

**重要メソッド:**

```python
calculate_confidence_score(video_info, extracted_timestamps)
# 役割: 歌配信の確度を0.0-1.0で評価
# 評価基準:
#   - タイトルに「歌」「歌枠」があるか（+5点）
#   - タイムスタンプにアーティスト名があるか（+10点）
#   - コメントに「曲名 / アーティスト」形式があるか（+6点）
#   - 抽出されたタイムスタンプの数（+1-4点）

parse_song_title_artist(title)
# 役割: 「曲名 / アーティスト」を分離
# 例: "夜に駆ける / YOASOBI" → ("夜に駆ける", "YOASOBI")

detect_genre(title, artist)
# 役割: ジャンルを自動判定
# 優先度: 完全一致 > キーワードマッチ > デフォルト

is_valid_song_entry(title, artist)
# 役割: 有効な曲エントリかを判定
# 除外: ナンバリングのみ、記号のみ、無効キーワード
```

#### 主要関数: `scrape_channels(channel_ids, output_file)`

**処理フロー:**
1. チャンネルの動画一覧を取得
2. 歌配信を1次フィルタリング（タイトル・概要欄で判定）
3. コメント取得
4. 歌配信を2次フィルタリング（コメント分析で精度向上）
5. タイムスタンプ抽出
6. 重複除去（曲名・アーティスト・動画ID・タイムスタンプで判定）
7. CSV出力
8. 統計表示

### 2. genre_classifier.py（ジャンル分類）

**設定ファイル:** `config/genre_keywords.json`

**分類ロジック:**
```python
# 優先度1: アーティスト名の完全一致
if artist in artist_to_genre:
    return artist_to_genre[artist]

# 優先度2: キーワードマッチング
# Vocaloid > アニメ > J-POP > その他
```

**ジャンル定義:**
- **Vocaloid**: 初音ミク、DECO*27等のボカロP
- **アニメ**: アニソン、アニメOP/ED
- **J-POP**: 商業音楽アーティスト
- **その他**: 上記以外

### 3. channel_manager.py（チャンネル管理）

**データ形式（user_ids.json）:**
```json
{
  "channels": [
    {
      "name": "チャンネル名",
      "channel_id": "UCxxxxxxxxxxxxxxxxxxxxxx",
      "enabled": true
    }
  ]
}
```

---

## 📊 データ構造

### 入力データ

#### user_ids.json
```json
{
  "channels": [
    {
      "name": "チャンネル1",
      "channel_id": "UCxxxxxxxxxxxxxxxxxxxxxx",
      "enabled": true
    }
  ]
}
```

#### config/genre_keywords.json
```json
{
  "categories": {
    "Vocaloid": {
      "vocaloid_characters": [...],
      "producers": [...],
      "keywords": [...]
    },
    "アニメ": {...},
    "J-POP": {...}
  },
  "artist_to_genre": {
    "YOASOBI": "J-POP",
    "DECO*27": "Vocaloid"
  }
}
```

### 出力データ

#### song_timestamps_complete.csv（最重要）
```csv
No,曲,歌手-ユニット,検索用,ジャンル,タイムスタンプ,配信日,動画ID,確度スコア
1,夜に駆ける,YOASOBI,夜に駆ける,J-POP,00:25:36,2025/02/04,N9dsnKVpRwA,0.60
2,ヒバナ,DECO*27,ひばな,Vocaloid,5:21,2025/05/28,RY-Htvm-zpY,1.0
```

**列の説明:**
- **No**: 通し番号
- **曲**: 曲名
- **歌手-ユニット**: アーティスト名（空の場合もある）
- **検索用**: ひらがな変換した曲名
- **ジャンル**: Vocaloid/J-POP/アニメ/その他
- **タイムスタンプ**: mm:ss または hh:mm:ss 形式
- **配信日**: 配信日（JST）
- **動画ID**: YouTube動画ID
- **確度スコア**: 0.0-1.0（歌配信の信頼度）

---

## ⚙️ 重要なロジック

### 1. 確度スコア計算（最新版）

**評価項目と配点:**
```python
# 基本スコア（最大22点）
タイトルに「歌」「歌枠」: +5点
タイトルに音楽記号（♪🎵等）: +2点
概要欄にタイムスタンプ3個以上: +2点
歌関連キーワード: +1点/個

# タイムスタンプの質（最大14点）
アーティスト名抽出率 > 80%: +10点
アーティスト名抽出率 > 50%: +6点
アーティスト名抽出率 > 20%: +3点
タイムスタンプ数 >= 20: +4点
タイムスタンプ数 >= 10: +3点
タイムスタンプ数 >= 5: +2点

# コメント分析（最大10点）
「曲名 / アーティスト」形式 >= 3: +6点
コメントにタイムスタンプ多数: +4点

# 除外キーワード
「ゲーム」「雑談」等: -1点/個

# 正規化
normalized_score = raw_score / 44.0
```

**スコアの解釈:**
- **0.8-1.0**: 確実に歌配信（アーティスト名が豊富）
- **0.5-0.8**: 歌配信の可能性が高い
- **0.3-0.5**: 歌配信か不明瞭
- **0.0-0.3**: 歌配信ではない可能性

### 2. 重複除去ロジック

**重複判定キー:**
```python
normalized_key = (
    song_title.lower().strip(),      # 曲名（小文字・前後空白除去）
    artist.lower().strip(),          # アーティスト（小文字・前後空白除去）
    video_id,                        # 動画ID
    total_seconds // 5               # タイムスタンプ（±5秒以内は同一）
)
```

**重複時の選択基準:**
```python
best = max(duplicates, key=lambda x: (
    not x['has_numbering'],  # ナンバリングがない方を優先
    len(x['song_title']),    # 曲名が長い方を優先
    len(x['artist'])         # アーティスト名が長い方を優先
))
```

### 3. ジャンル分類ロジック

**優先順位:**
1. `artist_to_genre`でアーティスト名完全一致
2. `categories`でキーワードマッチング（Vocaloid → アニメ → J-POP）
3. デフォルトは「その他」

---

## 📈 統計出力

### スクレイプ完了時の統計表示

```
統計:
   - 処理した動画数: 10
   - 抽出したタイムスタンプ数: 350
   - 最終出力行数: 241

   確度スコア分布:
   - 高確度 (>0.7): 50件 (30.5%)
   - 中確度 (0.4-0.7): 80件 (48.8%)
   - 低確度 (<0.4): 34件 (20.7%)
   - 平均確度: 0.62

   ジャンル別統計:
   - その他: 106曲 (44.0%)
   - Vocaloid: 67曲 (27.8%)
   - アニメ: 36曲 (14.9%)
   - J-POP: 32曲 (13.3%)
```

---

## 🚀 実行方法

### 1. 初期設定
```bash
# 必須: YouTube Data API v3のAPIキーを.envに設定
echo "API_KEY=your_api_key_here" > .env

# チャンネルID設定
# user_ids.jsonに対象チャンネルIDを追加
```

### 2. スクレイプ実行
```bash
python main.py
# メニューから「2. チャンネル選択してスクレイプ」を選択
```

### 3. 出力確認
```
output/csv/song_timestamps_complete.csv  # メインCSV
output/json/comment_info.json            # バックアップJSON
```

---

## 🎨 今後の改善方針

### 優先度: 高
1. **タイムスタンプ抽出精度の向上**
   - より多様なフォーマットに対応
   - 正規表現パターンの改善

2. **アーティスト名抽出の改善**
   - 「feat.」「×」「cv.」等の特殊表記への対応
   - 複数アーティストの処理

3. **ジャンル分類の精度向上**
   - `genre_keywords.json`の充実
   - 機械学習による分類（将来）

### 優先度: 中
4. **確度スコアの改善**
   - 動画の長さを考慮
   - 視聴回数・コメント数の比率を考慮

5. **ノイズ除去の強化**
   - より洗練された除外キーワード
   - 文脈を考慮した判定

### 優先度: 低
6. **UI/UX改善**
   - プログレスバーの表示
   - エラーハンドリングの強化

---

## ⚠️ 注意事項

### 開発時の注意
1. **主目的を見失わない**: タイムスタンプの正確な抽出が最優先
2. **テストデータで検証**: 既存のCSVと比較して改善を確認
3. **統計を確認**: 確度スコア分布やジャンル統計で品質をチェック

### API制限
- YouTube Data API v3には日次クォータ制限あり
- 大量のチャンネルを一度にスクレイプすると制限に達する可能性

### データ品質
- アーティスト名の抽出率が最も重要な指標
- 80%以上が理想、50%以下なら改善が必要

---

## 📝 変更履歴

### 2025-11-03: 確度スコア改善版
- タイムスタンプの質を評価するロジックを追加
- 統計表示を強化（確度スコア分布 + ジャンル別統計）
- 動的な正規化（最大44点）

### 以前のバージョン
- 基本的なタイムスタンプ抽出機能
- ジャンル分類機能
- コメント分析による精度向上

---

## 🔗 関連ドキュメント

- `confidence_score_improvements.md` - 確度スコア改善案
- `config/genre_keywords.json` - ジャンル分類設定
- `README.md` - 基本的な使い方（要作成）

---

**Last Updated**: 2025-11-03
**Version**: 2.0
